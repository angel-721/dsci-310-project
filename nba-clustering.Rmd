---
title: "nba-clustering"
author: "Angel Manuel Velasquez"
date: "2024-11-21"
output: html_notebook
---

## Load Packages and data
```{r echo = FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(ggcorrplot))

# Data Source: https://www.kaggle.com/datasets/owenrocchi/nba-advanced-stats-20022022
nba_stats_processed <- readRDS("nba_stats_processed.rds")
names <- readRDS("names.rds")
```


## Process Data 
```{r echo = FALSE}

# remove Pos. 
nba_stats_final <- nba_stats_processed |> select(-Pos)

# First, define the feature columns using tidyselect helpers
feature_columns <- c("VORP", "DWS", "OWS")

# Then create the training data using these columns
nba_stats_final <- nba_stats_processed |> 
  select( all_of(feature_columns))

```

## Use elbow method

```{r echo = FALSE:w}
WCSS <- sapply(1:7, function(k) kmeans(nba_stats_final,k)$tot.withinss)

WCSS

ggplot() +
  geom_point(aes(x = 1:7, y = WCSS), cex = 4) +
  geom_line(aes(x = 1:7, y = WCSS)) +
  labs(x = "Number of clusters (k)", 
       y = "Within-cluster sum of squares (WCSS)") +
  theme(text = element_text(size = 20))
```

## Fit a k-means model
```{r echo = FALSE}
kmModel <- kmeans(nba_stats_final, 4)
kmModel

nba_stats_processed$cluster <- as.factor(kmModel$cluster)
head(nba_stats_processed)

kmCenters <- as.data.frame(kmModel$centers)
kmCenters
nba_stats_processed$name <- names
```



## Visualize it
```{r echo = FALSE}
nba_stats_processed |> 
  ggplot(aes(x=VORP, y=DWS)) +
  geom_point(aes(color = cluster, shape = cluster), size=3) + 
  geom_point(data=kmCenters, aes(x=VORP, y=DWS), 
             color="black", size=10, shape = 18) +
  geom_text(aes(label = name), 
            size = 2, 
            vjust = -1, 
            check_overlap = TRUE) +
  labs(x='Value Over Replacement Player (VORP)', 
       y='Defensive Win Shares (DWS)', 
       title = 'NBA Player Clustering') +
  theme_minimal() +
  scale_color_manual(values = c("blue", "yellow", "pink", "red"), 
                     name = "Cluster")
```

```{r echo = FALSE}

# Add cluster centers to each row for comparison
nba_with_distances <- nba_stats_processed %>%
  rowwise() %>%
  mutate(
    distance_to_center = sqrt(
      sum((c_across(weight:DWS) - kmCenters[cluster, ])^2)  # Adjust column range as needed
    )
  )

# Find the row closest to each cluster center
closest_to_centers <- nba_with_distances %>%
  group_by(cluster) %>%
  slice_min(distance_to_center, n = 1)  # Get the closest row per cluster

# View the results
print(closest_to_centers$name)


```
